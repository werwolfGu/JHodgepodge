# redis持久化

## redis提供的持久化策略

1. **RDB（快照）**：这种策略在指定的时间间隔内，将redis内存中的数据以二进制的形式保存到磁盘上，生成数据快照。这种方式适合于希望在指定时间点恢复数据的场景；
2. **AOF(文件追加）**：这种策略记录服务器质性的所有写命令，并在服务器重启时，通过命令重放来还原数据。这种方式可以提供更好的数据安全性，但是可能会产生较大的文件，并在恢复时需要更多时间；
3. **混合持久化（RDB+AOF）**： 结合了RDB和AOF的优点，首先以RDB格式保存当前数据状态，然后`继续以AOF格式`记录新的写操作，确保数据完整性并优化恢复速度
4. **无持久化**：不使用任何持久化策略，使用于数据可丢失的场景；



### RDB（快照）

> RDB 快照持久化策略每次都会生成全量数据的快照。

- RDB优点
  - **速度**：生成快照是一个相对快速的过程，因为他是一次性写入操作；
  - **恢复速度快**：RDB文件通常较小，可以快速加载到内存中；
  - **数据完整性**：在快照创建时，可以确保文件中的数据是一只的。
- RDB缺点：
  - **数据丢失风险**：如果在生成快照之后和下一次快照生成之前发生故障，这段时间内的数据更改可能会丢失。
  - **性能影响**：虽然快照操作时原子的，但是在高负载情况下，仍然坑对性能产生影响；

### AOF（文件追加）

- **文件追加**：AOF持久化通过将所有写操作命令追加到一个文件来记录数据库状态的变化；
- **写操作策略**：
  - always ： 每个写操作都立即同步到AOF文件中，这保证了数据的安全性，但是可能对性能有影响；
  - everysec ： 每秒同步一次；
  - no : 让操作系统来决定何时同步，这可能会提高性能，但是有数据丢失的风险 ；

- **重写机制**

  随着时间的推移，AOF文件会越来越大，因为每个写操作都会被追加进去，包括很多相同的命令。Redis提供了AOF重写功能，它可以创建一个新的AOF文件，只包含恢复当前数据集所需的最少命令；

- **重写触发条件** 

  AOF重写可以在运行是触发，或者根据配置文件职工分的`auto-aof-rewrite-min-size` 和 `auto-aof-rewrite-percentage` 参数自动触发。

- **重写执行步骤**

  > AOF重写过程中，redis会创建一个新的子进程来执行重写操作，而主进程继续处理客户端请求;

  - **子进程开始重写**：当AOF重写开始时，redis会fork出一个子进程来处理重写任务，这个字进程会基于当前内存中的数据生成一个新的AOF文件，这个文件包含了重建数据库所需的所有写命令；
  - **新命令写入缓冲区**：与此同时，主进程继续接收新的客户端命令，并将这些命令写入到AOF缓冲区中；
  - **缓冲区刷新**：根据appendfsync配置，AOF缓冲区中的内容会定期刷新到AOF文件中，在重写过程中，这意味着新命令会被写入到旧的AOF文件中，直接重写完成；这是为了保证在重写过程中发生的写操作不会丢失。
  - **重写完成**：子进程完成新AOF文件的写入后，会向主进程发送信号，告知重写已完成；
  - **缓冲区刷新到新文件**：在收到子进程的重写完成信号后，主进程会将AOF缓冲区的内容刷新到新的AOF文件中。此时不会刷新到旧的AOF文件，因为旧文件即将被替换；
  - **替换旧的AOF文件**：主进程将新的AOF文件替换旧的AOF文件。这个替换操作非常快，并且在这短暂的时间内，新的写命令会被暂存在AOF缓存区中

### 混合持久化策略

> redis4.0版本 引入。它结合了 RDB 和 AOF 两种持久化方式的优点，旨在提供一种更高效、更安全的数据恢复方式。

#### 执行步骤

- **RDB快照**：混合持久化开始时，redis会创建一个RDB快照，这个快照是内存中数据的一个完整备份，记录某一时刻的数据状态；

- **AOF追加**：在RDB快照创建之后，Redis中所有的写操作都会被记录到AOF文件中，即使在RDB过程中新的写操作也会被记录到AOF文件中；

  











AOF重写：
https://www.jianshu.com/p/f72008c4d49f
https://zhuanlan.zhihu.com/p/340082703