# 磁盘爆满复盘

## 现象
  20210516 早上起来，突然收到短信告警，说服务器磁盘使用率达到了90%多，第一反应是日志打印太多了；
  所以先让运维将告警的服务器的日志清理了下；

  来到公司的第一时间点就是看为何会出现这个问题，发现原来上个版本一个将其中一个日志文件
  的console.log日志级别改成了info级别；导致console.log过大同时没有归档所以磁盘爆满了

  但是有一个疑问为何只有一台机器出现这个问题，集群中其他机器没有出现这个问题；最初考虑可能
  是某一个定时任务一直打在这台机器上，所以导致这个机器的日志比其他的多；

## 问题定位 
  现在就是要看是那个定时任务一直在这台机器上执行；首先是分析日志咯；打开日志惊到我了，

  1. 某一个定时任务的日志一直在打就没停过；
  2. 使用通过top 看CPU发现有一个CPU使用率一直是70%多；

  通过上面的两个现象我初步断定是出现死循环了，那么就去证实我的猜想；
  1. 通过 ps -ef|grep java 或  jps 查看进程ID；
  2. 通过top -Hp ${pid} 查看出现问题的线程号；
  3. printf "%x\n" tid 将10进制线程号转换成16进制； 
  4. 通过jstack ${pid}查看堆栈信息；检索对应线程的堆栈线程；


  通过对该线程的堆栈分析，同时翻看源码，发现这个定时任务真的是出现了死循环；

## 解决方案
  临时解决方案

  定时任务停掉，将出现磁盘爆满的大日志文件删掉 > console.log  ;

  最终解决方案

  修改定时任务代码，确保不会出现死循环；
  console.log日志级别修改成warn

## 总结

 1. 对于开发人员上线的代码还是没有review仔细，测试案例没有覆盖全面；不然这个死循环本应该是可以在测试环境发现；
 2. log的日志级别一般情况是不能修改；除非出现什么必须要修才能去修改；

